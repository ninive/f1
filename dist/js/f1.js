function spawn(){return p=game.add.sprite(820,1880,"car","car1"),p.anchor.setTo(.5,.5),p.angle=180,game.physics.enable(p,Phaser.Physics.ARCADE),p.body.collideWorldBounds=!0,p.body.bounce.setTo(3,3),p}function uPosition(e){cars[e.Id].x=e.X,cars[e.Id].y=e.Y,cars[e.Id].angle=e.ANGLE}var car,cars={},sock,ip="localhost",state={rpm:0,pos:null,init:function(){},preload:function(){game.load.atlas("car","img/f1/cars.png","img/f1/cars.json"),game.load.tilemap("testtrack","img/f1/watkins.json",null,Phaser.Tilemap.TILED_JSON),game.load.image("finishline","img/f1/tileset/finishlinev.png"),game.load.image("slower","img/f1/tileset/slower.png"),game.load.image("collide","img/f1/tileset/collide.png"),game.load.image("watkins","img/f1/tileset/watkins.png")},create:function(){game.physics.startSystem(Phaser.Physics.ARCADE),land=game.add.tilemap("testtrack"),land.addTilesetImage("finishline","finishline"),land.addTilesetImage("slower","slower"),land.addTilesetImage("collide","collide"),land.addTilesetImage("watkins","watkins"),track=land.createLayer("test"),track.resizeWorld(),finish=land.createLayer("finishline"),finish.resizeWorld(),finish.renderable=!1,land.setCollision(1783,!0,finish),land.setTileIndexCallback(1783,helpers.throttle(helpers.emitFinish,1e4,{trailing:!1}),game,finish),slower=land.createLayer("slowerline"),slower.resizeWorld(),slower.renderable=!1,land.setCollision(1784,!0,slower),land.setTileIndexCallback(1784,helpers.emitSlower,game,slower),collide=land.createLayer("collideline"),collide.resizeWorld(),collide.renderable=!1,land.setCollision(1785,!0,collide),land.fixedToCamera=!0,car=game.add.sprite(820,1880,"car","car1"),car.anchor.setTo(.5,.5),car.angle=180,game.physics.enable(car,Phaser.Physics.ARCADE),car.body.collideWorldBounds=!0,car.body.bounce.setTo(3,3),shadow=game.add.sprite(0,0,"car","shadow"),shadow.anchor.setTo(.35,.4),car.bringToTop(),game.camera.follow(car),game.camera.focusOnXY(0,0),cursors=game.input.keyboard.createCursorKeys(),window.addEventListener("deviceorientation",helpers.handleOrientation,!0),timer=game.time.create(!1),timer.start(),state.pos=JSON.stringify({x:car.x,y:car.y,angle:car.angle,cmdtime:timer.ms}),sock=new WebSocket("ws://"+ip+":3000/ws"),sock.onopen=function(){sock.send(state.pos)},sock.onmessage=function(e){var a=JSON.parse(e.data);a.New?cars[a.Id]=spawn(a):a.Online===!1?cars[a.Id].destroy():uPosition(a)}},update:function(){cursors.left.isDown?car.angle-=2:cursors.right.isDown&&(car.angle+=2),cursors.up.isDown?700>state.rpm&&(state.rpm+=3):state.rpm>0&&(state.rpm-=2),cursors.down.isDown&&(state.rpm>0?state.rpm-=10:0>=state.rpm&&(state.rpm=-80)),cursors.down.isUp&&0>state.rpm&&(state.rpm=0),state.pos=JSON.stringify({x:car.x,y:car.y,angle:car.angle,cmdtime:timer.ms}),1==sock.readyState&&sock.send(state.pos),car.body.maxVelocity.setTo(700,700),game.physics.arcade.collide(car,finish),game.physics.arcade.collide(car,slower),game.physics.arcade.collide(car,collide),game.physics.arcade.velocityFromRotation(car.rotation,state.rpm,car.body.velocity),shadow.x=car.x,shadow.y=car.y,shadow.rotation=car.rotation},render:function(){game.debug.text("RPM "+state.rpm,32,32),game.debug.text("Lap: "+helpers.lap,32,48),game.debug.text("Timing: "+timer.ms,32,64)}},helpers={lap:0,lastLap:[],emitFinish:function(){helpers.lap=helpers.lap+1,helpers.lastLap[helpers.lap]=timer.ms},emitSlower:function(){car.body.maxVelocity.setTo(150,150)},handleOrientation:function(e){var a=e.gamma,s=e.beta;e.alpha,car.angle+=.1*s,state.rpm-=.2*a},throttle:function(e,a,s){var r,t,i,l=null,n=0;s||(s={});var o=function(){n=new Date,l=null,i=e.apply(r,t)};return function(){var c=new Date;n||s.leading!==!1||(n=c);var d=a-(c-n);return r=this,t=arguments,0>=d?(clearTimeout(l),l=null,n=c,i=e.apply(r,t)):l||s.trailing===!1||(l=setTimeout(o,d)),i}}},game=new Phaser.Game(1366,642,Phaser.CANVAS,"f1",state);